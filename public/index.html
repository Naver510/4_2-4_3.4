<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jokebook UI</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 6px 0; padding: 8px 12px; }
    .box { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
    .muted { color: #666; font-size: 0.9em }
    ul { padding-left: 18px; }
    .category { font-weight: 600; color: #2a6f97; margin: 6px 0; }
    .joke-card { border: 1px solid #eee; padding: 10px; margin: 8px 0; border-radius: 6px; background: #fafafa }
    .joke-text { font-size: 1.05em; margin-bottom: 6px }
    .joke-response { color: #0b6623; font-weight: 600 }
    .cat { font-size: 0.85em; color: #555; margin-bottom: 6px }
    .form-row { margin: 8px 0; display:flex; flex-direction:column }
    #form-message { font-size: 0.95em }
    .form-success { color: #0b6623 }
    .form-error { color: #b00020 }
    .stats-table { border-collapse: collapse; width: 320px; margin-top: 8px }
    .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left }
    .stats-table th { background: #f3f7fa }
    .search-list { margin-top: 8px }
    .search-item { padding: 6px 8px; border-bottom: 1px solid #eee }
  </style>
</head>
<body>
  <h1>Jokebook — Frontend Demo</h1>
  <div>
    <button id="btn-categories">Pobierz kategorie</button>
    <button id="btn-random">Pobierz losowego żartu (dowolna kategoria)</button>
    <button id="btn-stats">Pokaż statystyki</button>
    <input id="search-word" type="text" placeholder="Wpisz słowo kluczowe" style="margin-left:8px; padding:6px;" />
    <button id="btn-search">Szukaj</button>
  </div>

  <!-- Add joke form -->
  <form id="add-joke-form" class="box" style="margin-top:16px;">
    <h3>Dodaj nowy żart</h3>
    <div class="form-row">
      <label>Kategoria</label>
      <select id="form-category">
        <option value="funnyJoke">funnyJoke</option>
        <option value="lameJoke">lameJoke</option>
      </select>
    </div>
    <div class="form-row">
      <label>Tekst żartu</label>
      <input id="form-joke" type="text" placeholder="Wpisz treść żartu" style="width:100%" />
    </div>
    <div class="form-row">
      <label>Odpowiedź</label>
      <input id="form-response" type="text" placeholder="Wpisz odpowiedź" style="width:100%" />
    </div>
    <div style="margin-top:8px">
      <button id="btn-add-joke" type="submit">Dodaj żart</button>
    </div>
    <div id="form-message" style="margin-top:8px"></div>
  </form>

  <div id="output" class="box">
    <div id="status" class="muted">Naciśnij przycisk, aby rozpocząć.</div>
    <div id="result"></div>
  </div>

  <script>
    const status = document.getElementById('status');
    const result = document.getElementById('result');

    function showStatus(s) { status.textContent = s; }

    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderCategories(arr) {
      if (!arr || arr.length === 0) return '<div class="muted">Brak kategorii</div>';
      return '<ul>' + arr.map(c => `<li class="category">${escapeHTML(c)}</li>`).join('') + '</ul>';
    }

    function renderJokeCard(item) {
      const cat = item.category ? `<div class="cat">${escapeHTML(item.category)}</div>` : '';
      return `
        <div class="joke-card">
          ${cat}
          <div class="joke-text">${escapeHTML(item.joke || item.joke)}</div>
          <div class="joke-response">${escapeHTML(item.response || item.response)}</div>
        </div>`;
    }

    function renderResults(data) {
      if (data === null || data === undefined) return '';

      // categories array (array of strings)
      if (Array.isArray(data) && data.every(d => typeof d === 'string')) {
        return renderCategories(data);
      }

      // single object with category + joke
      if (data && typeof data === 'object' && data.joke && data.response && data.category) {
        return renderJokeCard(data);
      }

      // array of joke objects
      if (Array.isArray(data) && data.every(d => typeof d === 'object' && (d.joke || d.response))) {
        if (data.length === 0) return '<div class="muted">Brak wyników</div>';
        return data.map(renderJokeCard).join('');
      }

      // fallback: pretty JSON
      return `<pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>`;
    }

    function showResult(obj) { result.innerHTML = renderResults(obj); }

    async function fetchCategories() {
      showStatus('Pobieram kategorie...');
      showResult('');
      try {
        const res = await fetch('/jokebook/categories');
        const data = await res.json();
        showStatus('Kategorie pobrane.');
        showResult(data);
        return data;
      } catch (err) {
        showStatus('Błąd podczas pobierania kategorii');
        showResult(err.toString());
        return [];
      }
    }

    async function fetchRandomJokeFromAnyCategory() {
      showStatus('Pobieram kategorie...');
      showResult('');
      try {
        const categories = await fetchCategories();
        if (!categories || categories.length === 0) {
          showStatus('Brak kategorii.');
          return;
        }
        const randomCategory = categories[Math.floor(Math.random() * categories.length)];
        showStatus(`Pobieram losowego żartu z kategorii: ${randomCategory}`);
        const res = await fetch(`/jokebook/joke/${encodeURIComponent(randomCategory)}`);
        const joke = await res.json();
        showStatus('Żart pobrany.');
        showResult(Object.assign({ category: randomCategory }, joke));
      } catch (err) {
        showStatus('Błąd podczas pobierania żartu');
        showResult(err.toString());
      }
    }

  // Add-joke form handling
  const addForm = document.getElementById('add-joke-form');
  const formMessage = document.getElementById('form-message');

  function showFormMessage(msg, isError) {
    formMessage.textContent = msg;
    formMessage.className = isError ? 'form-error' : 'form-success';
  }

  addForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showFormMessage('Wysyłam...', false);

    const category = document.getElementById('form-category').value;
    const jokeText = document.getElementById('form-joke').value.trim();
    const responseText = document.getElementById('form-response').value.trim();

    if (!jokeText || !responseText) {
      showFormMessage('Uzupełnij pola żartu i odpowiedzi.', true);
      return;
    }

    try {
      const res = await fetch(`/jokebook/joke/${encodeURIComponent(category)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ joke: jokeText, response: responseText })
      });

      const body = await res.json();
      if (body && body.error) {
        showFormMessage(`Błąd: ${body.error}`, true);
      } else {
        showFormMessage('Żart dodany pomyślnie.', false);
        // clear inputs
        document.getElementById('form-joke').value = '';
        document.getElementById('form-response').value = '';
        // update stats or UI if desired
      }
    } catch (err) {
      showFormMessage('Błąd sieci: ' + err.toString(), true);
    }
  });

  // Stats fetching and rendering
  function renderStatsTable(obj) {
    if (!obj || typeof obj !== 'object') return '<div class="muted">Brak danych</div>';
    const rows = Object.entries(obj).map(([k,v]) => `\n<tr><td>${escapeHTML(k)}</td><td>${escapeHTML(String(v))}</td></tr>`).join('');
    return `<table class="stats-table"><thead><tr><th>Kategoria</th><th>Liczba</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  async function fetchStats() {
    showStatus('Pobieram statystyki...');
    result.innerHTML = '';
    try {
      const res = await fetch('/jokebook/stats');
      const data = await res.json();
      showStatus('Statystyki pobrane.');
      result.innerHTML = renderStatsTable(data);
      return data;
    } catch (err) {
      showStatus('Błąd podczas pobierania statystyk');
      result.innerHTML = `<div class="form-error">Błąd sieci: ${escapeHTML(err.toString())}</div>`;
      return null;
    }
  }

    document.getElementById('btn-categories').addEventListener('click', fetchCategories);
    document.getElementById('btn-random').addEventListener('click', fetchRandomJokeFromAnyCategory);
    document.getElementById('btn-stats').addEventListener('click', fetchStats);

  // Search handling
  function renderSearchResults(arr) {
    if (!arr || arr.length === 0) return '<div class="muted">Brak żartów pasujących do wyszukiwania</div>';
    return '<div class="search-list">' + arr.map(item => {
      const cat = item.category ? `[${escapeHTML(item.category)}] ` : '';
      const joke = escapeHTML(item.joke || '');
      const resp = escapeHTML(item.response || '');
      return `<div class="search-item">${cat}${joke} — ${resp}</div>`;
    }).join('') + '</div>';
  }

  async function performSearch() {
    const w = document.getElementById('search-word').value.trim();
    if (!w) {
      showStatus('Wpisz słowo kluczowe do wyszukania.');
      result.innerHTML = '';
      return;
    }
    showStatus(`Szukam: ${w}`);
    try {
      const res = await fetch(`/jokebook/search?word=${encodeURIComponent(w)}`);
      const data = await res.json();
      showStatus('Wyniki wyszukiwania:');
      result.innerHTML = renderSearchResults(data);
    } catch (err) {
      showStatus('Błąd podczas wyszukiwania');
      result.innerHTML = `<div class="form-error">Błąd sieci: ${escapeHTML(err.toString())}</div>`;
    }
  }

  document.getElementById('btn-search').addEventListener('click', performSearch);
  document.getElementById('search-word').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); performSearch(); } });
  </script>
</body>
</html>
